<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Metrics - Admin</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body class="admin-body">
    <nav class="admin-nav">
        <div class="admin-nav-brand">
            <a href="/admin">Admin Panel</a>
        </div>
        <div class="admin-nav-links">
            <a href="/admin">Dashboard</a>
            <a href="/admin/streams">Streams</a>
            <a href="/admin/metrics" class="active">Metrics</a>
        </div>
        <div class="admin-nav-user">
            <span>{{.Username}}</span>
            <a href="/admin/logout" class="btn btn-secondary btn-sm">Logout</a>
        </div>
    </nav>

    <main class="admin-main">
        <div class="admin-container">
            <div class="admin-header">
                <h1>System Metrics</h1>
                <div class="refresh-indicator">
                    <span class="refresh-dot"></span>
                    <span>Auto-refresh: 1s</span>
                </div>
            </div>

            <!-- Alerts Section -->
            <div id="alerts-section" class="alerts-section" style="display: none;">
                <div id="alerts-container"></div>
            </div>

            <!-- Metrics Grid -->
            <div class="metrics-grid">
                <!-- SRS Container -->
                <div class="metrics-card">
                    <h3>SRS Container (paywall-srs)</h3>
                    <div id="srs-container" class="metrics-card-content">
                        <div style="text-align: center; color: var(--text-secondary);">Loading...</div>
                    </div>
                </div>

                <!-- Redis -->
                <div class="metrics-card">
                    <h3>Redis</h3>
                    <div class="metrics-card-content">
                        <div class="metric-row">
                            <span class="metric-label">Memory Usage</span>
                            <span id="redis-memory" class="metric-value">--</span>
                        </div>
                        <div class="progress-bar">
                            <div id="redis-memory-bar" class="progress-fill healthy" style="width: 0%"></div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Connected Clients</span>
                            <span id="redis-clients" class="metric-value">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Hit Rate</span>
                            <span id="redis-hitrate" class="metric-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- PostgreSQL -->
                <div class="metrics-card">
                    <h3>PostgreSQL</h3>
                    <div class="metrics-card-content">
                        <div class="metric-row">
                            <span class="metric-label">Connections</span>
                            <span id="pg-connections" class="metric-value">--</span>
                        </div>
                        <div class="progress-bar">
                            <div id="pg-connections-bar" class="progress-fill healthy" style="width: 0%"></div>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Active</span>
                            <span id="pg-active" class="metric-value">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Idle</span>
                            <span id="pg-idle" class="metric-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- Go Runtime -->
                <div class="metrics-card">
                    <h3>Go Runtime</h3>
                    <div class="metrics-card-content">
                        <div class="metric-row">
                            <span class="metric-label">Goroutines</span>
                            <span id="go-goroutines" class="metric-value large">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Heap Allocated</span>
                            <span id="go-heap" class="metric-value">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">Heap System</span>
                            <span id="go-heapsys" class="metric-value">--</span>
                        </div>
                        <div class="metric-row">
                            <span class="metric-label">GC Cycles</span>
                            <span id="go-gc" class="metric-value">--</span>
                        </div>
                    </div>
                </div>

                <!-- Server Container -->
                <div class="metrics-card">
                    <h3>Server (stream-paywall)</h3>
                    <div id="server-container" class="metrics-card-content">
                        <div style="text-align: center; color: var(--text-secondary);">Loading...</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
    // Metrics refresh interval
    const REFRESH_INTERVAL = 1000;

    // Fetch and update metrics
    async function fetchMetrics() {
        try {
            const response = await fetch('/admin/api/metrics');
            if (!response.ok) {
                throw new Error('Failed to fetch metrics');
            }
            const data = await response.json();
            updateUI(data);
        } catch (error) {
            console.error('Error fetching metrics:', error);
        }
    }

    // Update UI with metrics data
    function updateUI(metrics) {
        updateAlerts(metrics.alerts);
        updateSRSContainer(metrics.srsContainer);
        updateRedisMetrics(metrics.redis);
        updatePostgresMetrics(metrics.postgres);
        updateGoRuntimeMetrics(metrics.goRuntime);
        updateServerContainer(metrics.serverContainer);
    }

    // Update alerts section
    function updateAlerts(alerts) {
        const section = document.getElementById('alerts-section');
        const container = document.getElementById('alerts-container');

        if (!alerts || alerts.length === 0) {
            section.style.display = 'none';
            return;
        }

        section.style.display = 'block';
        container.innerHTML = alerts.map(alert => `
            <div class="alert-item ${alert.level}">
                <span class="alert-icon">&#9888;</span>
                <div class="alert-content">
                    <div class="alert-component">${escapeHtml(alert.component)}</div>
                    <div class="alert-message">${escapeHtml(alert.message)}</div>
                </div>
            </div>
        `).join('');
    }

    // Update SRS container
    function updateSRSContainer(srs) {
        const el = document.getElementById('srs-container');

        if (!srs) {
            el.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">SRS container not detected</div>';
            return;
        }

        el.innerHTML = `
            <div class="metric-row">
                <span class="metric-label">CPU</span>
                <span class="metric-value">${srs.cpuPercent.toFixed(1)}%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Memory</span>
                <span class="metric-value">${srs.memoryUsageMB.toFixed(0)} MB (${srs.memoryPercent.toFixed(1)}%)</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Network Rate</span>
                <span class="metric-value">${srs.networkRxMbps.toFixed(1)} Mb/s rx / ${srs.networkTxMbps.toFixed(1)} Mb/s tx</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Network Total</span>
                <span class="metric-value">${srs.networkRxMB.toFixed(1)} MB rx / ${srs.networkTxMB.toFixed(1)} MB tx</span>
            </div>
        `;
    }

    // Update Redis metrics
    function updateRedisMetrics(redis) {
        if (!redis) return;

        const memText = redis.maxMemoryMB > 0
            ? `${redis.usedMemoryMB.toFixed(1)} / ${redis.maxMemoryMB.toFixed(0)} MB`
            : `${redis.usedMemoryMB.toFixed(1)} MB`;
        document.getElementById('redis-memory').textContent = memText;

        const memBar = document.getElementById('redis-memory-bar');
        memBar.style.width = `${Math.min(redis.memoryPercent || 0, 100)}%`;
        memBar.className = `progress-fill ${getStatusClass(redis.memoryPercent || 0)}`;

        document.getElementById('redis-clients').textContent = redis.connectedClients;
        document.getElementById('redis-hitrate').textContent = `${redis.hitRate.toFixed(1)}%`;
    }

    // Update Postgres metrics
    function updatePostgresMetrics(pg) {
        if (!pg) return;

        const total = pg.activeConnections + pg.idleConnections;
        document.getElementById('pg-connections').textContent = `${total} / ${pg.maxConnections}`;

        const connBar = document.getElementById('pg-connections-bar');
        connBar.style.width = `${Math.min(pg.connectionPercent, 100)}%`;
        connBar.className = `progress-fill ${getStatusClass(pg.connectionPercent)}`;

        document.getElementById('pg-active').textContent = pg.activeConnections;
        document.getElementById('pg-idle').textContent = pg.idleConnections;
    }

    // Update Go runtime metrics
    function updateGoRuntimeMetrics(goRuntime) {
        if (!goRuntime) return;

        document.getElementById('go-goroutines').textContent = goRuntime.goroutines;
        document.getElementById('go-heap').textContent = `${goRuntime.heapAllocMB.toFixed(1)} MB`;
        document.getElementById('go-heapsys').textContent = `${goRuntime.heapSysMB.toFixed(1)} MB`;
        document.getElementById('go-gc').textContent = goRuntime.numGC;
    }

    // Update server container
    function updateServerContainer(server) {
        const el = document.getElementById('server-container');

        if (!server) {
            el.innerHTML = '<div style="text-align: center; color: var(--text-secondary);">Server container not detected</div>';
            return;
        }

        el.innerHTML = `
            <div class="metric-row">
                <span class="metric-label">CPU</span>
                <span class="metric-value">${server.cpuPercent.toFixed(1)}%</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Memory</span>
                <span class="metric-value">${server.memoryUsageMB.toFixed(0)} MB (${server.memoryPercent.toFixed(1)}%)</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Network Rate</span>
                <span class="metric-value">${server.networkRxMbps.toFixed(1)} Mb/s rx / ${server.networkTxMbps.toFixed(1)} Mb/s tx</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Network Total</span>
                <span class="metric-value">${server.networkRxMB.toFixed(1)} MB rx / ${server.networkTxMB.toFixed(1)} MB tx</span>
            </div>
        `;
    }

    // Get status class based on percentage
    function getStatusClass(percent) {
        if (percent >= 90) return 'critical';
        if (percent >= 75) return 'warning';
        return 'healthy';
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initial fetch and start auto-refresh
    fetchMetrics();
    setInterval(fetchMetrics, REFRESH_INTERVAL);
    </script>
</body>
</html>
