<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{if .IsEdit}}Edit Stream{{else}}New Stream{{end}} - Admin</title>
    <link rel="stylesheet" href="/static/css/style.css">
    <link rel="stylesheet" href="/static/css/admin.css">
</head>
<body class="admin-body">
    <nav class="admin-nav">
        <div class="admin-nav-brand">
            <a href="/admin">Admin Panel</a>
        </div>
        <div class="admin-nav-links">
            <a href="/admin">Dashboard</a>
            <a href="/admin/streams" class="active">Streams</a>
            <a href="/admin/metrics">Metrics</a>
        </div>
        <div class="admin-nav-user">
            <span>{{.Username}}</span>
            <a href="/admin/logout" class="btn btn-secondary btn-sm">Logout</a>
        </div>
    </nav>

    <main class="admin-main">
        <div class="admin-container">
            <div class="admin-header">
                <h1>{{if .IsEdit}}Edit Stream{{else}}New Stream{{end}}</h1>
            </div>

            {{if .IsEdit}}
            <!-- Streaming Info Panel (only for existing streams) -->
            <div class="streaming-info-card">
                <h2>Streaming Configuration</h2>

                <div class="streaming-info-grid">
                    <div class="streaming-info-item">
                        <label>Publishing Status</label>
                        <div>
                            {{if .Stream.IsPublishing}}
                            <span class="status-badge status-running">Publishing</span>
                            {{else}}
                            <span class="status-badge status-stopped">Not Publishing</span>
                            {{end}}
                        </div>
                    </div>

                    <div class="streaming-info-item">
                        <label>RTMP URL (for OBS)</label>
                        <div class="copy-field">
                            <code id="rtmp-url">{{.Stream.RTMPURL}}</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('rtmp-url')">Copy</button>
                        </div>
                    </div>

                    <div class="streaming-info-item">
                        <label>Stream Key (for OBS)</label>
                        <div class="copy-field">
                            <code id="stream-key">{{.Stream.StreamKey}}</code>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="copyToClipboard('stream-key')">Copy</button>
                        </div>
                    </div>
                </div>

                <!-- Video Encoding Settings (always accessible) -->
                <div class="video-settings-section" style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border);">
                    <h3>Video Quality Variants</h3>
                    <p class="form-help" style="margin-bottom: 1rem;">Configure multiple quality variants for adaptive bitrate streaming (ABR). Viewers will automatically switch between qualities based on their connection.</p>

                    <div id="video-settings-loading">Loading settings...</div>
                    <div id="video-settings-form" style="display: none;">
                        <!-- Preset Buttons -->
                        <div class="preset-buttons">
                            <span class="preset-label">Add preset:</span>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addPreset('1080p')">1080p</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addPreset('720p')">720p</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addPreset('480p')">480p</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addPreset('360p')">360p</button>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="addPreset('passthrough')">Passthrough</button>
                        </div>

                        <!-- Variants Table -->
                        <table class="admin-table variants-table" id="variants-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Bitrate (kbps)</th>
                                    <th>FPS</th>
                                    <th>Encoding Speed</th>
                                    <th>Passthrough</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="variants-body">
                                <!-- Variants will be rendered here by JavaScript -->
                            </tbody>
                        </table>

                        <div class="form-row" style="margin-top: 1rem;">
                            <div class="form-group">
                                <label for="latencyLevel">Stream Latency</label>
                                <select id="latencyLevel">
                                    <option value="1">Low latency (~4s delay)</option>
                                    <option value="2">Default (~6s delay)</option>
                                    <option value="3">High latency (~10s delay)</option>
                                    <option value="4">Highest latency (most stable)</option>
                                </select>
                                <div class="form-help">Lower latency = more responsive but less stable</div>
                            </div>
                        </div>

                        <div style="margin-top: 1rem;">
                            <button type="button" id="saveVideoSettings" class="btn btn-primary">Save Video Settings</button>
                            <span id="video-settings-status" style="margin-left: 1rem;"></span>
                        </div>
                    </div>
                    <div id="video-settings-error" class="error-message" style="display: none;"></div>
                </div>

                <div class="streaming-instructions">
                    <h3>OBS Setup Instructions</h3>
                    <ol>
                        <li>In OBS, go to Settings &rarr; Stream</li>
                        <li>Set Service to "Custom"</li>
                        <li>Paste the RTMP URL in the "Server" field</li>
                        <li>Paste the Stream Key in the "Stream Key" field</li>
                        <li>Click "Start Streaming" in OBS</li>
                        <li>Set the stream status to "Live" below</li>
                    </ol>
                </div>
            </div>
            {{end}}

            <div class="form-card">
                {{if .Error}}
                <div class="error-message">
                    {{.Error}}
                </div>
                {{end}}

                <form method="POST" action="{{if .IsEdit}}/admin/streams/{{.Stream.ID}}{{else}}/admin/streams{{end}}">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title">Title *</label>
                            <input type="text" id="title" name="title" required
                                   value="{{if .Stream}}{{.Stream.Title}}{{end}}"
                                   placeholder="My Awesome Stream">
                        </div>

                        <div class="form-group">
                            <label for="slug">Slug *</label>
                            <input type="text" id="slug" name="slug" required
                                   value="{{if .Stream}}{{.Stream.Slug}}{{end}}"
                                   placeholder="my-awesome-stream"
                                   pattern="[a-z0-9-]+"
                                   {{if .IsEdit}}readonly{{end}}>
                            <div class="form-help">URL-friendly identifier (lowercase, hyphens only)</div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" name="description" rows="3"
                                  placeholder="Optional description for the stream">{{if .Stream}}{{.Stream.Description}}{{end}}</textarea>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="price">Price (EUR) *</label>
                            <input type="number" id="price" name="price" required
                                   step="0.01" min="0"
                                   value="{{if .Stream}}{{printf "%.2f" .Stream.PriceEuros}}{{else}}9.90{{end}}"
                                   placeholder="9.90">
                        </div>

                        <div class="form-group">
                            <label for="max_viewers">Max Viewers</label>
                            <input type="number" id="max_viewers" name="max_viewers"
                                   min="0"
                                   value="{{if .Stream}}{{.Stream.MaxViewers}}{{else}}0{{end}}"
                                   placeholder="0 = unlimited">
                            <div class="form-help">0 means unlimited</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="start_time">Start Time</label>
                            <input type="datetime-local" id="start_time" name="start_time"
                                   value="{{if .Stream}}{{if .Stream.StartTime}}{{.Stream.StartTime.Format "2006-01-02T15:04"}}{{end}}{{end}}">
                        </div>

                        <div class="form-group">
                            <label for="end_time">End Time</label>
                            <input type="datetime-local" id="end_time" name="end_time"
                                   value="{{if .Stream}}{{if .Stream.EndTime}}{{.Stream.EndTime.Format "2006-01-02T15:04"}}{{end}}{{end}}">
                        </div>
                    </div>

                    {{if .IsEdit}}
                    <div class="form-group">
                        <label for="status">Status</label>
                        <select id="status" name="status">
                            <option value="scheduled" {{if eq .Stream.Status "scheduled"}}selected{{end}}>Scheduled</option>
                            <option value="live" {{if eq .Stream.Status "live"}}selected{{end}}>Live</option>
                            <option value="ended" {{if eq .Stream.Status "ended"}}selected{{end}}>Ended</option>
                        </select>
                    </div>
                    {{end}}

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            {{if .IsEdit}}Save Changes{{else}}Create Stream{{end}}
                        </button>
                        <a href="/admin/streams" class="btn btn-secondary">Cancel</a>
                    </div>
                </form>
            </div>

            {{if .IsEdit}}
            <!-- Whitelist Management -->
            <div class="form-card" style="margin-top: 2rem;">
                <h2>Email Whitelist</h2>
                <p class="form-help" style="margin-bottom: 1rem;">
                    Whitelisted emails can access this stream for free. They just need to enter their email on the "Already paid?" page.
                </p>

                <!-- Add to whitelist form -->
                <form id="whitelist-form" style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                    <input type="email" id="whitelist-email" placeholder="email@example.com" required style="flex: 1;">
                    <input type="text" id="whitelist-notes" placeholder="Notes (optional)" style="flex: 1;">
                    <button type="submit" class="btn btn-primary">Add</button>
                </form>

                <div id="whitelist-message" class="error-message" style="display: none;"></div>

                <!-- Whitelist table -->
                <table class="admin-table" id="whitelist-table">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Notes</th>
                            <th>Added</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="whitelist-body">
                        <tr><td colspan="4" style="text-align: center;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            {{end}}
        </div>
    </main>

    <script src="/static/js/admin.js"></script>
    <script>
    // Auto-generate slug from title
    document.addEventListener('DOMContentLoaded', function() {
        const titleInput = document.getElementById('title');
        const slugInput = document.getElementById('slug');

        if (!slugInput.readOnly && titleInput && slugInput) {
            titleInput.addEventListener('input', function() {
                if (!slugInput.dataset.edited) {
                    slugInput.value = titleInput.value
                        .toLowerCase()
                        .replace(/[^a-z0-9]+/g, '-')
                        .replace(/^-|-$/g, '');
                }
            });

            slugInput.addEventListener('input', function() {
                slugInput.dataset.edited = 'true';
            });
        }
    });

    // Copy to clipboard function
    function copyToClipboard(elementId) {
        const element = document.getElementById(elementId);
        const text = element.textContent;
        const btn = element.parentElement.querySelector('button');
        const originalText = btn.textContent;

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(function() {
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = originalText; }, 2000);
            }).catch(function() {
                fallbackCopy(text, btn, originalText);
            });
        } else {
            fallbackCopy(text, btn, originalText);
        }
    }

    function fallbackCopy(text, btn, originalText) {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            btn.textContent = 'Copied!';
            setTimeout(function() { btn.textContent = originalText; }, 2000);
        } catch (err) {
            btn.textContent = 'Failed';
            setTimeout(function() { btn.textContent = originalText; }, 2000);
        }
        document.body.removeChild(textarea);
    }
    </script>
    {{if .IsEdit}}
    <script>
    // Whitelist management
    const streamId = '{{.Stream.ID}}';
    const whitelistBody = document.getElementById('whitelist-body');
    const whitelistForm = document.getElementById('whitelist-form');
    const whitelistMessage = document.getElementById('whitelist-message');

    function showMessage(msg, isError) {
        whitelistMessage.textContent = msg;
        whitelistMessage.style.display = 'block';
        whitelistMessage.className = isError ? 'error-message' : 'success-message';
        setTimeout(() => { whitelistMessage.style.display = 'none'; }, 3000);
    }

    async function loadWhitelist() {
        try {
            const response = await fetch(`/api/admin/streams/${streamId}/whitelist`, {
                headers: { 'X-Admin-Key': '{{.AdminKey}}' }
            });
            const entries = await response.json();

            if (entries.length === 0) {
                whitelistBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-secondary);">No whitelisted emails</td></tr>';
                return;
            }

            whitelistBody.innerHTML = entries.map(entry => `
                <tr>
                    <td>${entry.email}</td>
                    <td>${entry.notes || '-'}</td>
                    <td>${new Date(entry.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromWhitelist('${entry.email}')">Remove</button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Failed to load whitelist:', error);
            whitelistBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--danger);">Failed to load</td></tr>';
        }
    }

    whitelistForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('whitelist-email').value;
        const notes = document.getElementById('whitelist-notes').value;

        try {
            const response = await fetch(`/api/admin/streams/${streamId}/whitelist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': '{{.AdminKey}}'
                },
                body: JSON.stringify({ email, notes })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to add email');
            }

            showMessage('Email added to whitelist', false);
            document.getElementById('whitelist-email').value = '';
            document.getElementById('whitelist-notes').value = '';
            loadWhitelist();
        } catch (error) {
            showMessage(error.message, true);
        }
    });

    async function removeFromWhitelist(email) {
        if (!confirm(`Remove ${email} from whitelist?`)) return;

        try {
            const response = await fetch(`/api/admin/streams/${streamId}/whitelist/${encodeURIComponent(email)}`, {
                method: 'DELETE',
                headers: { 'X-Admin-Key': '{{.AdminKey}}' }
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to remove email');
            }

            showMessage('Email removed from whitelist', false);
            loadWhitelist();
        } catch (error) {
            showMessage(error.message, true);
        }
    }

    // Load whitelist on page load
    loadWhitelist();
    </script>
    <script>
    // Video settings management - Multiple Variants Support
    const videoSettingsLoading = document.getElementById('video-settings-loading');
    const videoSettingsForm = document.getElementById('video-settings-form');
    const videoSettingsError = document.getElementById('video-settings-error');
    const videoSettingsStatus = document.getElementById('video-settings-status');
    const variantsBody = document.getElementById('variants-body');

    // Quality presets (with width/height for SRS/FFmpeg)
    const QUALITY_PRESETS = {
        '1080p': { name: '1080p', videoBitrate: 4500, framerate: 30, cpuUsageLevel: 3, videoPassthrough: false, vwidth: 1920, vheight: 1080 },
        '720p':  { name: '720p',  videoBitrate: 2500, framerate: 30, cpuUsageLevel: 3, videoPassthrough: false, vwidth: 1280, vheight: 720 },
        '480p':  { name: '480p',  videoBitrate: 1200, framerate: 30, cpuUsageLevel: 2, videoPassthrough: false, vwidth: 854, vheight: 480 },
        '360p':  { name: '360p',  videoBitrate: 800,  framerate: 30, cpuUsageLevel: 2, videoPassthrough: false, vwidth: 640, vheight: 360 },
        'passthrough': { name: 'Source', videoBitrate: 0, framerate: 0, cpuUsageLevel: 1, videoPassthrough: true, vwidth: 0, vheight: 0 }
    };

    // Current variants array
    let variants = [];

    // Encoding speed options
    const encodingSpeedOptions = [
        { value: 1, label: 'Fastest' },
        { value: 2, label: 'Fast' },
        { value: 3, label: 'Balanced' },
        { value: 4, label: 'Slow' },
        { value: 5, label: 'Slowest' }
    ];

    // Add a preset
    function addPreset(presetName) {
        const preset = QUALITY_PRESETS[presetName];
        if (!preset) return;

        const exists = variants.some(v => v.name === preset.name);
        if (exists) {
            alert(`${preset.name} variant already exists.`);
            return;
        }

        variants.push({ ...preset, audioPassthrough: true });
        renderVariantsTable();
    }

    // Remove a variant
    function removeVariant(index) {
        if (variants.length <= 1) {
            alert('At least one variant is required.');
            return;
        }
        if (confirm('Remove this variant?')) {
            variants.splice(index, 1);
            renderVariantsTable();
        }
    }

    // Update a variant field
    function updateVariant(index, field, value) {
        if (variants[index]) {
            if (field === 'videoPassthrough') {
                variants[index][field] = value;
            } else if (field === 'name') {
                variants[index][field] = value;
            } else {
                variants[index][field] = parseInt(value) || 0;
            }
        }
    }

    // Render the variants table
    function renderVariantsTable() {
        if (variants.length === 0) {
            variantsBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-secondary);">No variants configured. Add a preset above.</td></tr>';
            return;
        }

        variantsBody.innerHTML = variants.map((v, i) => `
            <tr>
                <td>
                    <input type="text" class="variant-input" value="${v.name || ''}"
                           onchange="updateVariant(${i}, 'name', this.value)" placeholder="Name">
                </td>
                <td>
                    <input type="number" class="variant-input" value="${v.videoBitrate || 0}"
                           onchange="updateVariant(${i}, 'videoBitrate', this.value)"
                           min="0" max="20000" step="100" ${v.videoPassthrough ? 'disabled' : ''}>
                </td>
                <td>
                    <input type="number" class="variant-input" value="${v.framerate || 0}"
                           onchange="updateVariant(${i}, 'framerate', this.value)"
                           min="0" max="120" step="1" ${v.videoPassthrough ? 'disabled' : ''}>
                </td>
                <td>
                    <select class="variant-input" onchange="updateVariant(${i}, 'cpuUsageLevel', this.value)">
                        ${encodingSpeedOptions.map(opt =>
                            `<option value="${opt.value}" ${v.cpuUsageLevel === opt.value ? 'selected' : ''}>${opt.label}</option>`
                        ).join('')}
                    </select>
                </td>
                <td>
                    <input type="checkbox" ${v.videoPassthrough ? 'checked' : ''}
                           onchange="handlePassthroughChange(${i}, this.checked)">
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeVariant(${i})">Remove</button>
                </td>
            </tr>
        `).join('');
    }

    // Handle passthrough toggle
    function handlePassthroughChange(index, checked) {
        variants[index].videoPassthrough = checked;
        if (checked) {
            variants[index].videoBitrate = 0;
            variants[index].framerate = 0;
        }
        renderVariantsTable();
    }

    // Load video settings from API
    async function loadVideoSettings(retryCount = 0) {
        const maxRetries = 3;
        const retryDelay = 1000;

        try {
            const response = await fetch(`/admin/api/streams/${streamId}/srs/settings`);
            if (!response.ok) {
                throw new Error('Failed to load settings');
            }
            const data = await response.json();

            if (data.videoSettings && data.videoSettings.videoQualityVariants && data.videoSettings.videoQualityVariants.length > 0) {
                variants = data.videoSettings.videoQualityVariants.map(v => ({
                    name: v.name || '',
                    videoBitrate: v.videoBitrate || 0,
                    framerate: v.framerate || 0,
                    cpuUsageLevel: v.cpuUsageLevel || 2,
                    videoPassthrough: v.videoPassthrough || false,
                    audioPassthrough: v.audioPassthrough !== false
                }));
            } else {
                variants = [{ ...QUALITY_PRESETS['720p'], audioPassthrough: true }];
            }

            renderVariantsTable();

            if (data.videoSettings && data.videoSettings.latencyLevel) {
                document.getElementById('latencyLevel').value = data.videoSettings.latencyLevel;
            }

            videoSettingsLoading.style.display = 'none';
            videoSettingsForm.style.display = 'block';
        } catch (error) {
            console.error('Failed to load video settings:', error);
            if (retryCount < maxRetries) {
                videoSettingsLoading.textContent = `Loading settings... (attempt ${retryCount + 2}/${maxRetries + 1})`;
                setTimeout(() => loadVideoSettings(retryCount + 1), retryDelay);
            } else {
                videoSettingsLoading.style.display = 'none';
                videoSettingsError.textContent = 'Failed to load video settings. Try refreshing the page.';
                videoSettingsError.style.display = 'block';
            }
        }
    }

    // Save video settings
    document.getElementById('saveVideoSettings').addEventListener('click', async function() {
        const btn = this;
        btn.disabled = true;
        videoSettingsStatus.textContent = 'Saving...';
        videoSettingsStatus.style.color = '';

        if (variants.length === 0) {
            videoSettingsStatus.textContent = 'At least one variant is required.';
            videoSettingsStatus.style.color = 'var(--danger)';
            btn.disabled = false;
            return;
        }

        const latencyLevel = parseInt(document.getElementById('latencyLevel').value);

        try {
            const response = await fetch(`/admin/api/streams/${streamId}/srs/settings`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    variants: variants,
                    latencyLevel: latencyLevel
                })
            });

            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Failed to save settings');
            }

            videoSettingsStatus.textContent = 'Saved!';
            videoSettingsStatus.style.color = 'var(--success)';
            setTimeout(() => { videoSettingsStatus.textContent = ''; }, 3000);
        } catch (error) {
            videoSettingsStatus.textContent = error.message;
            videoSettingsStatus.style.color = 'var(--danger)';
        } finally {
            btn.disabled = false;
        }
    });

    // Load video settings on page load
    loadVideoSettings();
    </script>
    {{end}}
</body>
</html>
